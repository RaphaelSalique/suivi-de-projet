{% extends "base.html.twig" %}

{% block body %}
    <div class="container-fluid">
        <div id="conteneur_filtre" class="row">
            <p class="col-md-6"><a class="btn btn-default" href="{{ path('app_default_add') }}" role="button">{{ 'entree.creer'|trans() }}</a></p>
            <div class="col-md-6" id="filtres_container">
            {{ render(controller('App\\Controller\\RechercheController:indexAction')) }}
            </div>
        </div>
{% if entrees|length > 0 %}
        <div class="col-lg-12 table-responsive">
            <table id="entrees" class="table table-striped table-bordered table-hover table-condensed">
                <thead>
                    <tr>
                        <th>{{ 'createur'|trans() }}</th>
                        <th>#</th>
                        <th>{{ 'piece_jointe'|trans() }}</th>
                        <th>{{ 'assigne'|trans() }}</th>
                        <th>{{ 'module_fonctionnalite'|trans() }}</th>
                        <th>{{ 'description'|trans() }}</th>
                        <th>{{ 'type'|trans() }}</th>
                        <th>{{ 'importance'|trans() }}</th>
                        <th>{{ 'commentaires'|trans() }}</th>
                        <th>{{ 'statut'|trans() }}</th>
                        <th class="nowrap">{{ 'testable_entete'|trans() }}</th>
                        <th>{{ 'duree'|trans() }}</th>
                        <th>Id</th>
                    </tr>
                </thead>
                <tfoot>
                    <tr>
                        <th>{{ 'createur'|trans() }}</th>
                        <th>#</th>
                        <th>{{ 'piece_jointe'|trans() }}</th>
                        <th>{{ 'assigne'|trans() }}</th>
                        <th>{{ 'module_fonctionnalite'|trans() }}</th>
                        <th>{{ 'description'|trans() }}</th>
                        <th>{{ 'type'|trans() }}</th>
                        <th>{{ 'importance'|trans() }}</th>
                        <th>{{ 'commentaires'|trans() }}</th>
                        <th>{{ 'statut'|trans() }}</th>
                        <th class="nowrap">{{ 'testable_entete'|trans() }}</th>
                        <th>{{ 'duree'|trans() }}</th>
                        <th>Id</th>
                    </tr>
                </tfoot>
                <tbody>
                       {% for entree in entrees %}
                        <tr class="{{ include('Default/classe_ligne.html.twig') }}">
                            <td><span data-toggle="tooltip" data-placement="top" title="{{ entree.createur.getNomAffichage() }}">{{ entree.createur.getNomAffichageReduit() }}</span></td>
                            <td>{{ entree.reference }}</td>
                            <td><p><a href="{{ path('app_piecejointe_add', {'entree': entree.id}) }}" class="btn btn-primary" role="button" title="{{ 'image.add'|trans() }}"><i class="glyphicon glyphicon-edit"></i></a></p>{{ include('Default/affiche_images.html.twig') }}</td>
                            <td><span data-toggle="tooltip" data-placement="top" title="{{ entree.assigne.getNomAffichage() }}">{{ entree.assigne.getNomAffichageReduit() }}</span></td>
                            <td>{{ entree.module.libelle }}</td>
                            <td>
                                <a data-toggle="collapse" href="#entreedesc{{ entree.id }}" aria-expanded="false" aria-controls="entreedesc{{ entree.id }}">
                                    {% if entree.description|length > 0 %}
                                        {{ entree.description|u.truncate(10, '...', false) }}
                                    {% endif %}
                                </a>
                                <div class="collapse" id="entreedesc{{ entree.id }}">
                                  <div class="well">
                                    {{ entree.description|nl2br }}
                                  </div>
                                </div>
                            </td>
                            <td>{{ entree.type|readable_enum }}</td>
                            <td>{{ entree.severite|readable_enum }}</td>
                            <td>
                                <p><a href="{{ path('app_commentaire_add', { 'entree': entree.id }) }}" class="btn btn-primary" role="button" title="{{ 'commentaire.add'|trans() }}"><i class="glyphicon glyphicon-pencil"></i></a></p>
                                <div class="panel-group" id="entreecomm{{ entree.id }}" role="tablist" aria-multiselectable="true">
                                    {% for commentaire in entree.commentaires %}
                                  <div class="panel panel-default">
                                    <div class="panel-heading" role="tab" id="commentairehead{{ commentaire.id }}">
                                      <h4 class="panel-title">
                                        <a data-toggle="collapse" data-parent="#entreecomm{{ entree.id }}" href="#commentairedetail{{ commentaire.id }}" aria-expanded="false" aria-controls="commentairedetail{{ commentaire.id }}">
                                          <span data-toggle="tooltip" data-placement="top" title="{{ commentaire.user.getNomAffichage() }}">{{ commentaire.user.getNomAffichageReduit() }}</span> {{ 'index_date_commentaire'|trans({ '%dateheure%': commentaire.dateheure|date('d/m/Y à H:i') }) }} : {{ commentaire.commentaire|u.truncate(10, '...', false) }}
                                        </a>
                                      </h4>
                                    </div>
                                    <div id="commentairedetail{{ commentaire.id }}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="commentairehead{{ commentaire.id }}">
                                      <div class="panel-body">
                                        <p><a href="{{ path('app_commentaire_edit', { 'entree': entree.id, 'commentaire': commentaire.id }) }}" class="btn btn-primary" role="button" title="{{ 'modifier'|trans() }}"><i class="glyphicon glyphicon-edit"></i></a>&nbsp;&nbsp;<a href="{{ path('app_commentaire_delete', { 'entree': entree.id, 'commentaire': commentaire.id }) }}" class="btn btn-danger" role="button" title="{{ 'supprimer'|trans() }}"><i class="glyphicon glyphicon-trash"></i></a></p>
                                        {{ commentaire.commentaire|nl2br }}
                                      </div>
                                    </div>
                                  </div>
                                  {% endfor %}
                                </div>
                                </td>
                            <td>{{ entree.statut|readable_enum }}</td>
                            <td>{{ entree.afficheTestable }}</td>
                            <td>{{ entree.afficheDuree }}</td>
                            <td>{{ "%'.04d"|format(entree.id) }}<p><a href="{{ path('app_default_edit', { 'entree': entree.id }) }}" class="btn btn-primary" role="button" title="{{ 'modifier'|trans() }}"><i class="glyphicon glyphicon-edit"></i></a></p></td>
                        </tr>
                       {% endfor %}
                </tbody>
            </table>
        </div>
{% else %}
<div class="text-danger">
     <p>Pas d'entrée</p>
</div>
{% endif %}
    </div>
    <div id="lightbox" class="lightbox-off">
        <img src="#" alt="" id="lightbox-img" />
        <p id="lightbox-close">X</p>
    </div>
{% endblock body %}

{% block javascripts %}
<script type="text/javascript" charset="utf-8">
$(document).ready(function() {
    $('[data-toggle="tooltip"]').tooltip();
    $('#entrees').dataTable( {
        "columns": [
            {"name": "identifiant", "orderable": true},
            {"name": "reference", "orderable": true},
            {"name": "piece_jointe", "orderable": true},
            {"name": "assigne", "orderable": true},
            {"name": "module", "orderable": true},
            {"name": "description", "orderable": false},
            {"name": "type", "orderable": true},
            {"name": "severite", "orderable": true},
            {"name": "commentaires", "orderable": false},
            {"name": "statut", "orderable": true},
            {"name": "testable", "orderable": true},
            {"name": "duree", "orderable": true},
            {"name": "cree", "orderable": true}
        ],
        "dom": 'C<"clear">lfrtip',
        "language":  {
            "url": "//cdn.datatables.net/plug-ins/1.10.6/i18n/French.json"
        },
        "lengthMenu": [[10, 25, 50, 100, -1], [10, 25, 50, 100, "Tous"]],
        initComplete: function () {
            var formulaire = $("<form name='formulaire' id='formulaire'></form>");
            $('#entrees').wrap(formulaire);
            var ligne2 = $("<tr id='ligne2'></tr>");
            $("#entrees thead").append(ligne2);
            this.api().columns().every( function () {
                var column = this;
                var index = this[0][0];
                var identifiantSelect = this.context[0].aoColumns[index].name;
                var thache = $('<th></th>');
                if ((index!=2) && (index!=4) && (index!=5) && (index!=8)) {
                    var select = $('<select id="' + identifiantSelect + '" name="' + identifiantSelect + '"><option value=""></option></select>')
                        .appendTo(thache.appendTo( $('#ligne2')))
                        .on( 'change', function () {
                            var val = $.fn.dataTable.util.escapeRegex(
                                $(this).val()
                            );
                            column
                                .search( val ? '^'+val+'$' : '', true, false )
                                .draw();
                        } );

                    column.data().unique().sort().each( function ( d, j ) {
                        var affichage = d;
                        var selection = d;
                        var selected = '';
                        if (this.state().columns[index].search.regex) {
                            var laRecherche = "^" + d + "$";
                            if (laRecherche == this.state().columns[index].search.search) {
                                selected = ' selected="selected"';
                            }
                        }
                        if (index==0) {
                            var regex = /"/gi
                            var abreviation = d.replace(regex,"'");
                            affichage = $(abreviation).text();
                            selection = affichage;
                        } else if (index==3) {
                            var regex = /"/gi
                            var abreviation = d.replace(regex,"'");
                            affichage = $(abreviation).text();
                            selection = affichage;
                        } else if (index==4) {
                            affichage = d.substr(0, 15);
                        } else if (index==6) {
                            affichage = d.substr(0, 3);
                        } else if (index==7) {
                            affichage = d.substr(0, 3);
                        } else if (index==9) {
                            affichage = d.substr(0, 3);
                        } else if (index==12) {
                            affichage = selection = d.substr(0,4);
                        }
                        select.append( '<option value="'+selection+'"' + selected + '>'+affichage+'</option>' )
                    } );
                } else if (index==4) {
                    var title = $('#entrees thead th').eq( index ).text();
                    var inputSaisie = $( '<input name="' + identifiantSelect + '" id="' + identifiantSelect + '" type="text" placeholder="Recherche '+title+'" />' )
                    .appendTo(thache.appendTo($('#ligne2')))
                    .on( 'keyup change', function () {
                           column
                            .search( this.value )
                            .draw();
                        } );
                } else {
                    $('#ligne2').append(thache);
                }
                if (index==9) {
                    select.val('Ouvert').trigger('change');
                }
            } );
            // On crée le bouton "enregistrer le filtre"
            var boutonSauvegarde = $('<button id="sauvegarde" class="btn btn-primary">{{ 'filtre.enregistrer'|trans() }}</button>');
            boutonSauvegarde.on('click', function() {
                var config = $('#formulaire').serialize();
                $.post('{{path('app_recherche_addajax')}}', {parametre: config})
                    .done(function(data) {
                        if ($('#conteneur_filtre ul').length < 1) {
                            var leLienConteneur = $('<a data-toggle="collapse" class="btn btn-primary pull-right" href="#filtres" aria-expanded="false" aria-controls="filtres">{{ 'filtre.liste'|trans() }}</a>');
                            var leConteneurUl = $('<ul class="collapse in list-group" id="filtres"></ul>');
                            $('#filtres_container').append(leLienConteneur);
                            $('#filtres_container').append(leConteneurUl);
                        }
                        var parametresArray = data.split("&");
                        var affichageButton = [];
                        $.each(parametresArray, function(index, value) {
                            var parametreArray = value.split('=');
                            if (parametreArray[1].trim() != '') {
                                affichageButton.push(parametreArray[0] + '  vaut ' + parametreArray[1]);
                            }
                        });
                        var affichageButtonStr = affichageButton.join(', ');
                        var leButton = $('<button class="btn" data-parametre="' +  data+ '">' + affichageButtonStr + '</button>');
                        var leLi = $('<li class="list-group-item"></li>');
                        leLi.append(leButton);
                        $('#conteneur_filtre ul').append(leLi);
                    });
            });
            $('#filtres_container').prepend(boutonSauvegarde);
        },
        pageLength: -1,
        stateSave: true
    } );

    $('.galerie').on('click', 'a', function() {
        $('#lightbox').removeClass('lightbox-off');
        $('#lightbox img').attr('src', $(this).attr('href'));
        return false;
    });
    $('#lightbox-close').on('click', function() {
        $('#lightbox').addClass('lightbox-off');
    });
    $('#conteneur_filtre ul').on('click', 'button', function() {
        var parametres = $(this).data('parametre');
        var parametresArray = parametres.split("&");
        $.each(parametresArray, function(index, value) {
            var parametreArray = value.split('=');
            var laValeur = parametreArray[1].replace('+', ' ');
            $('#' + parametreArray[0]).val(laValeur).trigger('change');
        });
    })

} );
</script>
{% endblock javascripts %}
